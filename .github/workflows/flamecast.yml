name: Flamecast

on:
  workflow_dispatch:
    inputs:
      prompt:
        description: "Prompt for Claude Code"
        required: true
        type: string
      base_branch:
        description: "Base branch for the PR"
        required: false
        type: string
        default: "main"
      target_repo:
        description: "Target repo (e.g. owner/repo). Leave empty for current repo."
        required: false
        type: string

jobs:
  flamecast:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Register workflow run
        id: register
        run: |
          RESPONSE=$(curl -s -X POST \
            -H "Authorization: Bearer ${{ secrets.FLAMECAST_API_KEY }}" \
            -H "Content-Type: application/json" \
            -d '{"workflowRunId": ${{ github.run_id }}, "repo": "${{ inputs.target_repo || github.repository }}", "sourceRepo": "${{ github.repository }}"}' \
            "https://api.flamecast.dev/api/workflow-runs")
          echo "run_db_id=$(echo $RESPONSE | jq -r '.id')" >> $GITHUB_OUTPUT
      - uses: smithery-ai/flamecast@v1
        with:
          prompt: ${{ inputs.prompt }}
          base_branch: ${{ inputs.base_branch }}
          target_repo: ${{ inputs.target_repo }}
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          flamecast_pat: ${{ secrets.FLAMECAST_PAT }}
      - name: Report completion
        if: always()
        run: |
          curl -s -X PATCH \
            -H "Authorization: Bearer ${{ secrets.FLAMECAST_API_KEY }}" \
            -H "Content-Type: application/json" \
            "https://api.flamecast.dev/api/workflow-runs/${{ steps.register.outputs.run_db_id }}" || true
